# å®‰è£ finmindapi
!pip install finmindapi --quiet

# å¼•å…¥å¥—ä»¶
from FinMind.data import DataLoader
import pandas as pd
import datetime

# è¼¸å…¥ä½ çš„ API é‡‘é‘°
token = "JoeHo148"  # â† è«‹åœ¨é€™è¼¸å…¥ä½ è‡ªå·±çš„ Tokenï¼

# ç™»å…¥ API
api = DataLoader()
api.login_by_token(api_token=token)

# è¨­å®šæ—¥æœŸç¯„åœï¼ˆæŠ“æœ€è¿‘10å€‹äº¤æ˜“æ—¥ï¼‰
end_date = datetime.date.today()
start_date = end_date - datetime.timedelta(days=15)

# å–å¾—ä¸Šå¸‚è‚¡ç¥¨æ¸…å–®
stock_list = api.taiwan_stock_info()
stock_ids = stock_list[stock_list["type"]=="ä¸Šå¸‚"]["stock_id"].tolist()

# åˆ†ææ¢ä»¶å‡½å¼
def analyze_stock(stock_id):
    try:
        df = api.taiwan_stock_daily(stock_id=stock_id,
                                     start_date=str(start_date),
                                     end_date=str(end_date))
        if df.empty or len(df) < 6:
            return None

        # æ¢ä»¶ä¸€ï¼šæ³•äººé€£çºŒè²·è¶…3æ—¥ä»¥ä¸Š
        df["foreign_net_buy"] = df["foreign_investor_buy"] - df["foreign_investor_sell"]
        df["é€£è²·"] = df["foreign_net_buy"] > 0
        if df["é€£è²·"].rolling(3).sum().iloc[-1] < 3:
            return None

        # æ¢ä»¶äºŒï¼šæˆäº¤é‡æ”¾å¤§ï¼ˆè¿‘3æ—¥å¹³å‡ > å‰5æ—¥å¹³å‡ï¼‰
        df["vol_ma3"] = df["Trading_Volume"].rolling(3).mean()
        df["vol_ma5"] = df["Trading_Volume"].rolling(5).mean()
        if df["vol_ma3"].iloc[-1] < df["vol_ma5"].iloc[-3]:
            return None

        # æ¢ä»¶ä¸‰ï¼šæ”¶ç›¤åƒ¹ä¸Šå‡ï¼ˆ5å¤©è‡³å°‘æ¼²3å¤©ï¼‰
        df["close_diff"] = df["close"].diff()
        if (df["close_diff"].tail(5) > 0).sum() < 3:
            return None

        return stock_id
    except:
        return None

# é–‹å§‹åˆ†æ
matched = []
print("ğŸ” åˆ†æä¸­ï¼Œè«‹ç¨å€™...")
for stock_id in stock_ids[:200]:  # æ¸›å°‘æ•¸é‡åšåˆæ­¥æ¸¬è©¦ï¼Œå¯æ”¹å›å…¨éƒ¨ stock_ids
    result = analyze_stock(stock_id)
    if result:
        matched.append(result)

# é¡¯ç¤ºçµæœ
print("\nâœ… ç¬¦åˆæ¢ä»¶çš„è‚¡ç¥¨ä»£è™Ÿï¼š", matched)
